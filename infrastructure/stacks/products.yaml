AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Product-related resources, including the on-demand database and public API endpoints.

Resources:
    ProductsOperationalTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ProductsOperational
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sku
            AttributeType: S
          - AttributeName: price
            AttributeType: N
          - AttributeName: type
        AttributeType: S
        KeySchema:
          - AttributeName: sku
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: PriceIndex
            KeySchema:
              - AttributeName: type
              - AttributeName: price
            Projection:
              ProjectionType: ALL


  GetProductsOperationalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../backend/get-products/
      Handler: bootstrap
      Runtime: provided.al2
      Tracing: Active
      Environment:
        Variables:
          PRODUCTS_TABLE_NAME: !Ref ProductsOperationalTable
      Policies:
        - DynamoDBReadPolicy: { TableName: !Ref ProductsOperationalTable }

  GetSKUsByPriceFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../../backend/get-skus-by-price/
      Handler: bootstrap
      Runtime: provided.al2
      Tracing: Active
      Environment:
        Variables:
          PRODUCTS_TABLE_NAME: !Ref ProductsOperationalTable
      Policies:
        - DynamoDBReadPolicy: { TableName: !Ref ProductsOperationalTable }

Outputs:
  ProductsOperationalLambdaArn:
    Value: !GetAtt GetProductsOperationalFunction.Arn
    Export:
      Name: ProductsOperationalLambdaArn
  SKUsByPriceLambdaArn:
    Value: !GetAtt GetSKUsByPriceFunction.Arn
    Export:
      Name: SKUsByPriceLambdaArn
  ProductsOperationalTableName:
    Value: !Ref ProductsOperationalTable
